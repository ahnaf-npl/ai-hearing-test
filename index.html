<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Hearing Prototype</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: #f0f2f5;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        color: #333;
      }
      .container {
        width: 400px;
        height: 600px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .page {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 24px;
        overflow: auto;
        box-sizing: border-box;
      }
      .hidden {
        display: none !important;
      }
      h1 {
        color: #0d9488;
        text-align: center;
      }
      h2 {
        font-size: 1.1em;
        color: #111;
        margin-top: 20px;
        margin-bottom: 10px;
      }
      .welcome-page p {
        text-align: center;
      }
      .welcome-page .button {
        margin-top: auto;
      }
      .button {
        background-color: #0d9488;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        text-align: center;
        margin-top: auto;
      }
      .button:hover {
        background-color: #0f766e;
      }
      .survey-options label {
        display: block;
        background-color: #f8f8f8;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        border: 1px solid #eee;
      }
      .survey-options label:has(input:checked) {
        background-color: #dcf8c6;
        border-color: #0d9488;
      }
      .survey-options input {
        margin-right: 10px;
      }
      .chat-container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: 0;
      }
      .chat-header {
        padding: 16px;
        background-color: #0d9488;
        color: #fff;
        font-weight: 700;
        text-align: center;
        flex-shrink: 0;
      }
      .chat-box {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 2px;
        background-color: #f0f2f5;
      }
      .message-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 85%;
        margin-bottom: 10px;
      }
      .message-wrapper.user {
        align-self: flex-end;
        align-items: flex-end;
      }
      .message-wrapper.ai,
      .message-wrapper.system {
        align-self: flex-start;
        align-items: flex-start;
      }
      .message {
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 100%;
        line-height: 1.4;
        word-wrap: break-word;
      }
      .message-wrapper.user .message {
        background-color: #dcf8c6;
        border-bottom-right-radius: 4px;
      }
      .message-wrapper.ai .message,
      .message-wrapper.system .message {
        background-color: #fff;
        border-bottom-left-radius: 4px;
      }
      .timestamp {
        font-size: 11px;
        color: #888;
        margin-top: 4px;
        padding: 0 8px;
      }
      .typing-indicator {
        align-self: flex-start;
        display: flex;
        gap: 5px;
        padding: 10px 15px;
      }
      .typing-indicator span {
        width: 8px;
        height: 8px;
        background-color: #b0b0b0;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
      }
      .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
      }
      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }
      .chat-form-container {
        padding: 10px;
        border-top: 1px solid #e0e0e0;
        background-color: #fff;
        flex-shrink: 0;
      }
      .chat-form {
        display: flex;
        align-items: center;
      }
      .trigger-button {
        width: 100%;
        padding: 10px;
        border: 1px solid #0d9488;
        color: #0d9488;
        background-color: #fff;
        border-radius: 18px;
        cursor: pointer;
        font-size: 16px;
      }
      .trigger-button:hover {
        background-color: #f0f2f5;
      }
      .trigger-button:disabled {
        cursor: not-allowed;
        background-color: #e9ecef;
        color: #6c757d;
        border-color: #ced4da;
      }
      #user-input {
        flex-grow: 1;
        border: 1px solid #ccc;
        border-radius: 18px;
        padding: 10px 15px;
        font-size: 16px;
        outline: none;
      }
      #user-input:focus {
        border-color: #0d9488;
      }
      #send-btn,
      #mic-btn {
        background-color: #0d9488;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        margin-left: 10px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        flex-shrink: 0;
      }
      #mic-btn {
        margin-left: 0;
        margin-right: 5px;
        background-color: #6c757d;
      }
      #mic-btn.listening {
        background-color: #dc3545;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="welcome-page" class="page welcome-page">
        <h1>AIヒアリングへようこそ</h1>
        <p>AIがあなたについて深掘りしますので覚悟をしてくださいね！</p>
        <button id="start-btn" class="button">スタート</button>
      </div>

      <div id="survey-page" class="page hidden">
        <h1>アンケート</h1>
        <form id="survey-form">
          <div id="question1">
            <h2>1. 今どこに住んでいますか？</h2>
            <div class="survey-options">
              <label
                ><input
                  type="radio"
                  name="location"
                  value="jepang"
                  required
                />日本</label
              >
              <label
                ><input
                  type="radio"
                  name="location"
                  value="indonesia"
                  required
                />インドネシア</label
              >
            </div>
          </div>
          <div id="question2" class="hidden">
            <h2 id="question2-title"></h2>
            <div id="options-japan" class="survey-options hidden">
              <label
                ><input
                  type="radio"
                  name="status"
                  value="ginou_jisshu"
                  required
                />技能実習中</label
              >
              <label
                ><input
                  type="radio"
                  name="status"
                  value="tokutei_ginou"
                  required
                />特定技能で働いている</label
              >
              <label
                ><input
                  type="radio"
                  name="status"
                  value="ryugaku_intern"
                  required
                />留学やインターンシップで滞在中</label
              >
              <label
                ><input
                  type="radio"
                  name="status"
                  value="lainnya"
                  required
                />上記以外（またはよくわからない）</label
              >
            </div>
            <div id="options-indonesia" class="survey-options hidden">
              <label
                ><input
                  type="radio"
                  name="status"
                  value="moto_ginou_jisshu"
                  required
                />元技能実習生</label
              >
              <label
                ><input
                  type="radio"
                  name="status"
                  value="moto_tokutei_ginou"
                  required
                />以前に特定技能で働いていた</label
              >
              <label
                ><input
                  type="radio"
                  name="status"
                  value="belum_pernah_kerja_jp"
                  required
                />日本で働いたことがない</label
              >
              <label
                ><input
                  type="radio"
                  name="status"
                  value="moto_ryugaku_intern"
                  required
                />以前に留学やインターンで日本に滞在</label
              >
              <label
                ><input
                  type="radio"
                  name="status"
                  value="berhenti_magang"
                  required
                />技能実習を途中でやめた</label
              >
              <label
                ><input
                  type="radio"
                  name="status"
                  value="lainnya"
                  required
                />上記以外（またはよくわからない）</label
              >
            </div>
          </div>
          <button type="submit" class="button">チャットに続く</button>
        </form>
      </div>

      <div id="chat-page" class="page hidden">
        <div class="chat-container">
          <div class="chat-header">Chat with AI Assistant</div>
          <div id="chat-box" class="chat-box"></div>
          <div id="chat-form-container" class="chat-form-container">
            <form id="chat-form" class="chat-form">
              <input
                type="text"
                id="user-input"
                placeholder="メッセージを入力…"
                autocomplete="off"
              />
              <button type="button" id="mic-btn" class="chat-button">
                <i class="bi bi-mic-fill"></i>
              </button>
              <button type="submit" id="send-btn" class="chat-button">➤</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        let userData = { email: null, id: null };
        let patternId = null;

        // --- GANTI URL WEBHOOK INI ---
        // const mainWebhookUrl =
        //   "https://n8n-main.sliplane.app/webhook-test/af92b919-fcfb-4a4e-93fb-44b831d73450";
        // const historyCheckWebhookUrl =
        //   "https://n8n-main.sliplane.app/webhook-test/66a281fc-2579-40e7-a1d8-2771b9f04778";
        const mainWebhookUrl =
          "https://norimax.app.n8n.cloud/webhook-test/e-bridge-interview-main";
        const historyCheckWebhookUrl =
          "https://norimax.app.n8n.cloud/webhook-test/e-bridge-interview-start";

        // --- Elemen DOM ---
        const pages = {
          welcome: document.getElementById("welcome-page"),
          survey: document.getElementById("survey-page"),
          chat: document.getElementById("chat-page"),
        };
        const startBtn = document.getElementById("start-btn");
        const chatBox = document.getElementById("chat-box");
        const chatFormContainer = document.getElementById(
          "chat-form-container"
        );
        const surveyForm = document.getElementById("survey-form");

        function initializeApp() {
          const urlParams = new URLSearchParams(window.location.search);
          userData.email = urlParams.get("email");
          userData.id = urlParams.get("id");
          console.log("[INIT] Data pengguna dari URL:", userData);

          startBtn.addEventListener("click", handleStartClick);
          if (surveyForm) {
            surveyForm.addEventListener("submit", handleSurveySubmit);
            const q1Radios = surveyForm.querySelectorAll(
              'input[name="location"]'
            );
            q1Radios.forEach((radio) =>
              radio.addEventListener("change", handleLocationChange)
            );
          }

          attachFormListeners();
          showPage("welcome");
        }

        function initializeApp() {
          const urlParams = new URLSearchParams(window.location.search);
          userData.email = urlParams.get("email");
          userData.id = urlParams.get("id");
          console.log("[INIT] Data pengguna dari URL:", userData);

          // HANYA SATU LISTENER INI UNTUK TOMBOL START
          startBtn.addEventListener("click", handleStartClick);

          // Listener untuk elemen lain
          const surveyForm = document.getElementById("survey-form");
          if (surveyForm) {
            surveyForm.addEventListener("submit", handleSurveySubmit);
            const q1Radios = surveyForm.querySelectorAll(
              'input[name="location"]'
            );
            q1Radios.forEach((radio) =>
              radio.addEventListener("change", handleLocationChange)
            );
          }

          attachFormListeners();
          showPage("welcome");
        }

        function attachFormListeners() {
          const form = document.getElementById("chat-form");
          if (form) form.addEventListener("submit", handleChatSubmit);

          const micBtn = document.getElementById("mic-btn");
          if (micBtn && speech) {
            micBtn.addEventListener("click", toggleSpeechRecognition);
          }
        }

        // async function handleStartClick() {
        //   startBtn.disabled = true;
        //   startBtn.textContent = "確認中...";

        //   if (!userData.id || !userData.email) {
        //     alert("Authentication Error: ID dan Email pengguna wajib ada.");
        //     startBtn.disabled = false;
        //     startBtn.textContent = "スタート";
        //     return;
        //   }

        //   try {
        //     const response = await fetch(historyCheckWebhookUrl, {
        //       method: "POST",
        //       headers: { "Content-Type": "application/json" },
        //       body: JSON.stringify(userData),
        //     });
        //     if (!response.ok)
        //       throw new Error("Gagal menghubungi server pengecekan riwayat.");
        //     const data = await response.json();

        //     if (data.historyFound) {
        //       console.log("[AUTH] Riwayat ditemukan. Melewatkan survei.");
        //       patternId = data.patternId;
        //       displayChatHistory(data.history);
        //       showPage("chat");
        //       showTriggerButton();
        //     } else {
        //       console.log(
        //         "[AUTH] Riwayat tidak ditemukan. Lanjutkan ke survei."
        //       );
        //       showPage("survey");
        //     }
        //   } catch (error) {
        //     console.error("[AUTH] Error saat memeriksa riwayat:", error);
        //     alert("Gagal memeriksa riwayat percakapan. Silakan coba lagi.");
        //     startBtn.disabled = false;
        //     startBtn.textContent = "スタート";
        //   }
        // }

        async function handleStartClick() {
          startBtn.disabled = true;
          startBtn.textContent = "確認中..."; // Mengindikasikan sedang loading

          if (!userData.id || !userData.email) {
            alert("Authentication Error: ID dan Email pengguna wajib ada.");
            startBtn.disabled = false;
            startBtn.textContent = "スタート";
            return;
          }

          // AWAIT akan BERHENTI di sini dan menunggu fetch selesai
          try {
            const response = await fetch(historyCheckWebhookUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(userData),
            });

            if (!response.ok) {
              throw new Error("Gagal menghubungi server pengecekan riwayat.");
            }

            const data = await response.json();

            // Kode di bawah ini HANYA akan berjalan SETELAH fetch selesai
            if (data.historyFound) {
              console.log("[AUTH] Riwayat ditemukan. Melewatkan survei.");
              patternId = data.patternId; // Simpan patternId dari riwayat
              displayChatHistory(data.history);
              showPage("chat");
              showTriggerButton(); // Tampilkan tombol trigger
            } else {
              console.log(
                "[AUTH] Riwayat tidak ditemukan. Lanjutkan ke survei."
              );
              showPage("survey"); // <-- Pindah ke survei HANYA jika histori tidak ada
            }
          } catch (error) {
            console.error("[AUTH] Error saat memeriksa riwayat:", error);
            alert("Gagal memeriksa riwayat percakapan. Silakan coba lagi.");
            startBtn.disabled = false;
            startBtn.textContent = "スタート";
          }
        }

        function displayChatHistory(history) {
          chatBox.innerHTML = "";
          history.forEach((item) => {
            const role =
              item.role === "system" || item.role === "ai" ? "ai" : "user";
            addMessage(item.message, role, item.timestamp);
          });
        }

        function showTriggerButton() {
          chatFormContainer.innerHTML =
            '<button id="trigger-btn" class="trigger-button">再開する</button>';
          document
            .getElementById("trigger-btn")
            .addEventListener("click", handleTriggerClick);
        }

        function showChatForm() {
          chatFormContainer.innerHTML = `
                <form id="chat-form" class="chat-form">
                    <input type="text" id="user-input" placeholder="メッセージを入力…" autocomplete="off" />
                    <button type="button" id="mic-btn" class="chat-button"><i class="bi bi-mic-fill"></i></button>
                    <button type="submit" id="send-btn" class="chat-button">➤</button>
                </form>`;
          attachFormListeners();
        }

        async function handleTriggerClick() {
          const triggerBtn = document.getElementById("trigger-btn");
          triggerBtn.disabled = true;
          triggerBtn.textContent = "AIの応答を待っています...";
          await submitMessage("再開する");
          showChatForm();
        }

        async function handleChatSubmit(event) {
          event.preventDefault();
          const userInputEl = document.getElementById("user-input");
          const userText = userInputEl.value.trim();
          if (userText === "") return;
          userInputEl.value = "";
          await submitMessage(userText);
        }

        async function submitMessage(text, isInitial = false) {
          if (!isInitial) addMessage(text, "user");
          setTyping(true);

          const payload = {
            message: text,
            isInitialMessage: isInitial,
            email: userData.email,
            userId: userData.id,
            patternId: patternId,
          };

          try {
            const response = await fetch(mainWebhookUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (!response.ok)
              throw new Error(`HTTP error! status: ${response.status}`);

            setTyping(false);
            await processN8nResponse(response, isInitial);
          } catch (error) {
            console.error("[CHAT] Gagal mendapatkan balasan:", error);
            setTyping(false);
            addMessage(
              "申し訳ありませんが、AIへの接続中にエラーが発生しました。後でもう一度お試しください。",
              "ai"
            );
          }
        }

        function addMessage(
          text,
          sender,
          timestampStr = null,
          customId = null
        ) {
          const messageWrapper = document.createElement("div");
          const role =
            sender === "ai" && text.includes("初期化しています")
              ? "system"
              : sender;
          messageWrapper.className = `message-wrapper ${role}`;
          if (customId) messageWrapper.id = customId;

          const messageElement = document.createElement("div");
          messageElement.className = "message";
          messageElement.textContent = text;
          messageWrapper.appendChild(messageElement);

          if (timestampStr) {
            const timestampElement = document.createElement("div");
            timestampElement.className = "timestamp";
            const date = new Date(timestampStr);
            timestampElement.textContent = date.toLocaleString("ja-JP", {
              hour: "2-digit",
              minute: "2-digit",
            });
            messageWrapper.appendChild(timestampElement);
          }

          chatBox.appendChild(messageWrapper);
          chatBox.scrollTop = chatBox.scrollHeight;
        }

        function handleLocationChange(event) {
          const q2Container = document.getElementById("question2");
          const q2Title = document.getElementById("question2-title");
          const q2Options = {
            japan: document.getElementById("options-japan"),
            indonesia: document.getElementById("options-indonesia"),
          };

          const location = event.target.value;
          q2Container.classList.remove("hidden");
          if (location === "jepang") {
            q2Title.textContent = "2. 日本では何をしていますか？";
            q2Options.japan.classList.remove("hidden");
            q2Options.indonesia.classList.add("hidden");
          } else if (location === "indonesia") {
            q2Title.textContent = "2. 今あなたのステータスは何ですか？";
            q2Options.indonesia.classList.remove("hidden");
            q2Options.japan.classList.add("hidden");
          }
          document
            .querySelectorAll('input[name="status"]')
            .forEach((r) => (r.checked = false));
        }

        async function handleSurveySubmit(event) {
          event.preventDefault();
          patternId = getPatternId(
            surveyForm.location.value,
            surveyForm.status.value
          );
          console.log(`[SURVEY] Pattern ID yang ditentukan: ${patternId}`);
          showPage("chat");

          addMessage(
            "現在、ユーザーの情報を初期化しています。少々お待ちください。",
            "ai",
            null,
            "default-system-message"
          );
          await submitMessage("", true);
        }

        async function processN8nResponse(response, isInitial) {
          if (isInitial) {
            const defaultMessage = document.getElementById(
              "default-system-message"
            );
            if (defaultMessage) defaultMessage.remove();
          }

          const data = await response.json();
          console.log("[FETCH] Respons setelah di-parse menjadi JSON:", data);

          const replies = [data.reply1, data.reply2, data.reply3];
          for (const replyText of replies) {
            if (replyText) {
              await new Promise((resolve) => setTimeout(resolve, 600));
              addMessage(replyText, "ai");
            }
          }
        }

        function getPatternId(location, status) {
          if (status === "lainnya") return 9;
          if (location === "jepang") {
            if (status === "ginou_jisshu") return 1;
            if (status === "tokutei_ginou") return 2;
            if (status === "ryugaku_intern") return 3;
          } else if (location === "indonesia") {
            if (status === "moto_ginou_jisshu") return 4;
            if (status === "belum_pernah_kerja_jp") return 5;
            if (status === "moto_ryugaku_intern") return 6;
            if (status === "moto_tokutei_ginou") return 7;
            if (status === "berhenti_magang") return 8;
          }
          return 9;
        }

        function showPage(pageName) {
          Object.values(pages).forEach((page) => page.classList.add("hidden"));
          pages[pageName].classList.remove("hidden");
        }

        function setTyping(isTyping) {
          let indicator = document.getElementById("typing-indicator");
          if (isTyping && !indicator) {
            indicator = document.createElement("div");
            indicator.id = "typing-indicator";
            indicator.className = "message typing-indicator";
            indicator.innerHTML = "<span></span><span></span><span></span>";
            chatBox.appendChild(indicator);
            chatBox.scrollTop = chatBox.scrollHeight;
          } else if (!isTyping && indicator) {
            indicator.remove();
          }
        }

        // --- KODE LENGKAP SPEECH RECOGNITION ---
        var recognizing = false;
        var speech = (() => {
          const SpeechRecognition =
            window.SpeechRecognition || window.webkitSpeechRecognition;
          return SpeechRecognition ? new SpeechRecognition() : null;
        })();

        function toggleSpeechRecognition() {
          if (recognizing) {
            speech.stop();
          } else {
            speech.start();
          }
        }

        if (!speech) {
          console.log("Browser tidak mendukung SpeechRecognition!");
          const micBtn = document.getElementById("mic-btn");
          if (micBtn) micBtn.style.display = "none";
        } else {
          speech.lang = "ja-JP";
          speech.continuous = false;
          speech.interimResults = true;

          speech.onstart = () => {
            recognizing = true;
            const micBtn = document.getElementById("mic-btn");
            const userInput = document.getElementById("user-input");
            if (micBtn) micBtn.classList.add("listening");
            if (userInput) userInput.placeholder = "Mendengarkan...";
          };
          speech.onend = () => {
            recognizing = false;
            const micBtn = document.getElementById("mic-btn");
            const userInput = document.getElementById("user-input");
            if (micBtn) micBtn.classList.remove("listening");
            if (userInput) userInput.placeholder = "メッセージを入力…";
          };
          speech.onerror = (event) => {
            console.error("Speech recognition error:", event.error);
          };
          speech.onresult = (event) => {
            const userInput = document.getElementById("user-input");
            if (!userInput) return;

            let interim_transcript = "";
            let final_transcript = "";
            for (let i = event.resultIndex; i < event.results.length; ++i) {
              if (event.results[i].isFinal) {
                final_transcript += event.results[i][0].transcript;
              } else {
                interim_transcript += event.results[i][0].transcript;
              }
            }
            userInput.value = final_transcript;
            if (interim_transcript) userInput.placeholder = interim_transcript;
          };
        }

        initializeApp();
      });
    </script>
  </body>
</html>
